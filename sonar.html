<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>revibe</title>
    <style>
        /* Basic styles for the application */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
            box-sizing: border-box;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 10px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            width: 400px;
            position: absolute;
        }

        .welcome-title {
            font-size: 36px;
            margin-bottom: 20px;
            color: #e74c3c;
        }

        .update-log {
            margin-bottom: 20px;
            font-size: 16px;
            color: #ecf0f1;
        }

        button {
            padding: 10px 20px;
            background-color: #3498db;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .grid-container {
            position: relative;
            overflow: hidden;
            width: 800px;
            height: 800px;
            border: 2px solid #fff;
            margin-right: 10px;
            border-radius: 10px;
            display: none;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(40, 20px);
            grid-auto-rows: 20px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .grid div {
            position: relative;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #2980b9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; /* Change cursor style to pointer */
        }

        .grid div:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .player {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(46, 204, 113, 0.8);
            border-radius: 50%;
            transition: transform 0.2s ease;
            z-index: 1;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 220px;
        }

        #coordinates,
        #coins,
        #coinTimer {
            margin-top: 5px;
            font-size: 18px;
            text-align: center;
        }

        #resetButton {
            padding: 8px;
            background-color: #e74c3c;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 16px;
        }

        #resetButton:hover {
            background-color: #c0392b;
        }

        .tool-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .tool-box h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
            text-decoration: underline;
            color: #ecf0f1;
        }

        .emoji-list,
        .block-list {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .emoji-button,
        .block-button {
            cursor: pointer;
            margin: 2px;
            display: inline-block;
            width: 20px;
            height: 20px;
            transition: border 0.2s;
            font-size: 20px;
        }

        .emoji-button:hover,
        .block-button:hover {
            border: 2px solid #fff;
        }

        .delete-button {
            cursor: pointer;
            color: #e74c3c;
            margin-top: 5px;
            font-size: 28px;
        }

        input[type="file"] {
            display: none;
        }

        #addColorButton,
        #uploadMapButton,
        #addEmojiButton,
        #saveMapButton {
            margin-top: 5px;
            padding: 5px;
            background-color: #2980b9;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
        }

        #addColorButton:hover,
        #uploadMapButton:hover,
        #addEmojiButton:hover,
        #saveMapButton:hover {
            background-color: #1a5276;
        }

        .coin {
            font-size: 20px;
            color: gold;
            position: relative;
            z-index: 0;
        }

        .color-block {
            width: 20px;
            height: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-title">Welcome to Revibe</div>
        <div class="update-log">
            <h3>Update Logs:</h3>
            <ul>
                <li>Version 1.0: Initial Release</li>
                <li>Version 1.1: Added custom emojis and block features.</li>
                <li>Version 1.2: Improved UI and functionality, added download/load maps feature, added portals and made it so you can go through doors </li>
                <li>Version 1.3: Added portal functionality.</li>
            
            </ul>
        </div>
        <button id="startButton">Play</button>
    </div>

    <div class="grid-container" id="gridContainer">
        <div class="grid" id="grid"></div>
        <div class="player" id="player"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <div id="coordinates">Coordinates: (20, 20)</div>
        <div id="coins">Coins: 0</div>
        <div id="coinTimer">Next Coin in: 1200s</div>
        <div class="tool-box">
            <h2>Tools</h2>
            <div class="emoji-list" id="emojiList">
                <div class="emoji-button" data-emoji="üåô">üåô</div>
                <div class="emoji-button" data-emoji="‚≠ê">‚≠ê</div>
                <div class="emoji-button" data-emoji="üåπ">üåπ</div>
                <div class="emoji-button" data-emoji="üçø">üçø</div>
                <div class="emoji-button" data-emoji="‚õΩ">‚õΩ</div>
                <div class="emoji-button" data-emoji="üöò">üöò</div>
                <div class="emoji-button" data-emoji="üöî">üöî</div>
                <div class="emoji-button" data-emoji="üö™">üö™</div>
                <div class="emoji-button" data-emoji="üåÄ">üåÄ</div>
            </div>

            <h2>Blocks</h2>
            <div class="block-list" id="blockImageList">
                <div class="block-button" data-color="orange">
                    <img src="https://z0nyy.xyz/orange-drop.png" alt="Orange" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="green">
                    <img src="https://z0nyy.xyz/green-drop.png" alt="Green" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="blue">
                    <img src="https://z0nyy.xyz/blue-drop.png" alt="Blue" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="red">
                    <img src="https://z0nyy.xyz/red-drop.png" alt="Red" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="pink">
                    <img src="https://z0nyy.xyz/pink-block.png" alt="Pink" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="black">
                    <img src="https://z0nyy.xyz/black-drop.png" alt="Black" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="brown">
                    <img src="https://z0nyy.xyz/brown-drop.png" alt="Brown" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="white">
                    <img src="https://z0nyy.xyz/white-drop.png" alt="White" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button" data-color="yellow">
                    <img src="https://z0nyy.xyz/yellow-drop.png" alt="Yellow" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/rainbow-mushroom.png" alt="Rainbow Mushroom" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/rainbow-block.png" alt="Rainbow Block" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/vice-block.png" alt="Vice Block" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/rain-flame.png" alt="Rain Flame" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/purple-custom.png" alt="Purple Custom" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/purple-bear.png" alt="Purple Bear" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/lion-bear.png" alt="Lion Bear" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/da-baby.png" alt="Da Baby" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/chrome-block.png" alt="Chrome Block" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/Ben.png" alt="Ben" style="width: 20px; height: 20px;" />
                </div>
                  <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/IMG_5876.jpeg" alt="pink bear" style="width: 20px; height: 20px;" />
                </div>
                <div class="block-button">
                    <img src="https://raw.githubusercontent.com/zelity/cw/refs/heads/main/images/IMG_0603.png" alt="black bear" style="width: 20px; height: 20px;" />
                </div>
                 <div class="block-button">
                    <img src="https://assets.sutori.com/user-uploads/image/76734e4b-1961-4d5b-b214-e63065fd98f0/144501e5d39ef72449cc1f11eb46f364.jpeg" alt="polyphemus" style="width: 20px; height: 20px;" />
                </div>
            </div>

            <h2>Add Emoji</h2>
            <div class="emoji-input-container">
                <input type="text" id="emojiInput" placeholder="Enter Emoji (e.g., ‚≠ê)" />
                <button id="addEmojiButton">Add Emoji</button>
            </div>

            <h2>Create Color Block</h2>
            <div class="color-input-container">
                <input type="text" id="colorInput" placeholder="Hex code (e.g., #ABCDEF)" />
                <button id="addColorButton">Add Color</button>
            </div>

            <div class="delete-button" id="deleteButton">‚ùå</div>
            <button id="saveMapButton" class="upload-button">Save Map</button>
            <button id="uploadMapButton" class="upload-button">Upload Map</button>
            <input type="file" id="uploadMapInput" accept=".json" />
        </div>

        <button id="resetButton">Reset Map</button>
    </div>

    <script>
        // Show welcome screen initially
        document.getElementById('welcomeScreen').style.display = 'flex';
        document.getElementById('gridContainer').style.display = 'none';

        const localStorageKey = "customColorBlocks";

        // Start button functionality
        document.getElementById('startButton').addEventListener('click', function () {
            document.getElementById('welcomeScreen').style.display = 'none'; // Hide welcome screen
            document.getElementById('gridContainer').style.display = 'block'; // Show grid container
            startGame(); // Start the game
        });

        // Main game logic initialization
        function startGame() {
            const player = document.getElementById('player');
            const grid = document.getElementById('grid');
            const coordinatesDisplay = document.getElementById('coordinates');
            const coinsDisplay = document.getElementById('coins');
            const coinTimerDisplay = document.getElementById('coinTimer');
            const resetButton = document.getElementById('resetButton');

            // Load player position and portals from local storage, fallback to (20, 20)
            let position = JSON.parse(localStorage.getItem('playerPosition')) || { x: 20, y: 20 };
            let portals = JSON.parse(localStorage.getItem('portals')) || []; // Load portals
            let currentItem = ''; // Default item (block or emoji)
            let currentColor = ''; // Default color
            let currentEmoji = ''; // Default emoji
            let coins = 0; 
            let coinCountdown = 1200; // Countdown for next coin spawn set to 20 minutes (1200 seconds)
            let timerInterval;
            let currentCoin = null; // Variable to store the current coin element

            // Load custom color blocks from local storage
            let customColorBlocks = JSON.parse(localStorage.getItem(localStorageKey)) || [];

            // Create a larger grid (40x40)
            for (let i = 0; i < 1600; i++) {
                const cell = document.createElement('div');
                cell.addEventListener('click', function () {
                    // In delete mode, delete the block or emoji
                    if (this.dataset.filled) {
                        if (deleteMode) {
                            this.innerHTML = ''; // Clear previous content
                            delete this.dataset.filled; // Mark as empty
                            delete this.dataset.emoji; // Clear emoji dataset
                            delete this.dataset.colorBlock; // Clear color block dataset (if any)
                            saveMap(); // Save map state after deletion
                        }
                    } else {
                        // Place blocks or emojis
                        if (currentItem) {
                            const blockElement = document.createElement('img'); // Create an img for the block
                            blockElement.src = currentItem; // Set the block image source
                            blockElement.style.width = '20px'; // Set block size
                            blockElement.style.height = '20px'; // Set block size
                            this.innerHTML = ''; // Clear previous content
                            this.appendChild(blockElement); // Append block image
                            this.dataset.filled = 'true'; // Mark as filled
                        } else if (currentEmoji) {
                            const emojiElement = document.createElement('div'); // Create a div for the emoji
                            emojiElement.textContent = currentEmoji; // Set emoji text
                            emojiElement.style.fontSize = '20px'; // Set emoji size
                            this.innerHTML = ''; // Clear previous content
                            this.appendChild(emojiElement); // Append emoji to cell
                            this.dataset.filled = 'true'; // Mark as filled
                            this.dataset.emoji = currentEmoji; // Store emoji in dataset

                            // Add portal to the list if it's a spiral
                            if (currentEmoji === 'üåÄ') {
                                const portalCoords = { x: Math.floor(i % 40), y: Math.floor(i / 40) };
                                portals.push(portalCoords); // Add portal coordinates
                                localStorage.setItem('portals', JSON.stringify(portals)); // Update local storage
                            }
                        } else if (currentColor) {
                            const colorBlockElement = document.createElement('div'); // Create a div for the color block
                            colorBlockElement.style.backgroundColor = currentColor; // Set the background color
                            colorBlockElement.className = 'color-block'; // Add class for styling
                            this.innerHTML = ''; // Clear previous content
                            this.appendChild(colorBlockElement); // Append color block
                            this.dataset.filled = 'true'; // Mark as filled
                            this.dataset.colorBlock = currentColor; // Store the color for further usage
                        }

                        // Save to localStorage when a cell is placed
                        saveMap();
                    }
                });
                grid.appendChild(cell);
            }

            // Load previous map state from local storage
            loadMap();

            // Move player smoothly to their position
            function movePlayer(newPos) {
                player.style.transform = `translate(${(newPos.x * 20)}px, ${(newPos.y * 20)}px)`;
                position = newPos; // Update player position
                savePlayerPosition(); // Save player's position in local storage
            }

            // Spawn player at the loaded position
            movePlayer(position);

            // Update Coordinates and Timer on screen
            function updateDisplay() {
                coordinatesDisplay.textContent = `Coordinates: (${position.x}, ${position.y})`;
                coinsDisplay.textContent = `Coins: ${coins}`;
                coinTimerDisplay.textContent = `Next Coin in: ${coinCountdown}s`;
            }

            // Handle spawning coin
            function spawnCoin() {
                // Avoid generating coins in filled cells
                let coinPosition;
                do {
                    coinPosition = Math.floor(Math.random() * 1600);
                } while (grid.children[coinPosition].dataset.filled); // Ensure coin is not placed on a filled block

                currentCoin = grid.children[coinPosition];
                currentCoin.innerHTML = '<span class="coin">üí∞</span>'; // Place coin in the random position
                currentCoin.dataset.filled = true; // Mark as filled
                currentCoin.dataset.coin = 'true'; // Store coin dataset
            }

            // Countdown for new coin spawning
            function startCoinTimer() {
                timerInterval = setInterval(() => {
                    coinCountdown--;
                    if (coinCountdown <= 0) {
                        spawnCoin();
                        coinCountdown = 1200; // Reset the countdown to 20 minutes (1200 seconds)
                    }
                    updateDisplay();
                }, 1000); // Update every second
            }

            // Handle player movement
            document.addEventListener('keydown', function (event) {
                let newPos = { ...position };

                if (event.key === 'w' && position.y > 0) newPos.y--;
                else if (event.key === 's' && position.y < 39) newPos.y++;
                else if (event.key === 'a' && position.x > 0) newPos.x--;
                else if (event.key === 'd' && position.x < 39) newPos.x++;

                const targetCell = grid.children[newPos.y * 40 + newPos.x];

                // Allow the player to move through the door and the spiral portal
                if (!targetCell.dataset.filled || 
                    targetCell.dataset.emoji === 'üö™' || 
                    targetCell.dataset.emoji === 'üåÄ') {

                    // Check for coin collection
                    if (targetCell.dataset.coin) {
                        coins++; // Increase coin count
                        updateDisplay();
                        targetCell.innerHTML = ''; // Remove the coin from the grid
                        delete targetCell.dataset.filled; // Mark as empty
                        delete targetCell.dataset.coin; // Remove coin dataset
                    }

                    // Check for spiral teleportation
                    if (targetCell.dataset.emoji === 'üåÄ') {
                        const otherPortals = portals.filter(portal => !(portal.x === newPos.x && portal.y === newPos.y));
                        if (otherPortals.length > 0) {
                            movePlayer(newPos);
                            const randomPortal = otherPortals[Math.floor(Math.random() * otherPortals.length)];
                            setTimeout(() => {
                                movePlayer(randomPortal); // Teleport to the selected portal location
                            }, 0); // Immediately after
                            return; // Exit to prevent standard movement after teleport
                        }
                    }
                    movePlayer(newPos); // Move player to the new position
                }

                updateDisplay();
            });

            // Delete block or emoji functionality
            const deleteButton = document.getElementById('deleteButton');
            let deleteMode = false; // Variable to track delete mode

            deleteButton.addEventListener('click', function () {
                deleteMode = !deleteMode; // Toggle delete mode
                
                // Optionally provide visual feedback for delete mode activation
                deleteButton.style.color = deleteMode ? '#fff' : '#e74c3c'; // Change color
            });

            // Reset functionality
            resetButton.addEventListener('click', function () {
                Array.from(grid.children).forEach(cell => {
                    cell.innerHTML = '';
                    delete cell.dataset.filled; // Clear dataset for the reset
                    delete cell.dataset.emoji; // Clear emoji from dataset
                    delete cell.dataset.colorBlock; // Clear color block dataset
                    delete cell.dataset.coin; // Clear coin dataset
                });
                coins = 0; // Reset coins
                coinCountdown = 1200; // Reset coin timer
                position = { x: 20, y: 20 }; // Reset player position to (20, 20)
                movePlayer(position); // Move player to reset position
                updateDisplay();
                clearInterval(timerInterval); // Stop timer
                spawnCoin(); // Spawn new coin after reset
                startCoinTimer(); // Restart coin timer
                portals = []; // Reset portals
                localStorage.removeItem('mapData'); // Clear saved map data from local storage
                localStorage.removeItem('playerPosition'); // Clear saved player position
                localStorage.removeItem('portals'); // Clear portals from local storage
                localStorage.removeItem(localStorageKey); // Clear custom color blocks from local storage
            });

            // Block and emoji button functionality
            const blockButtons = document.querySelectorAll('.block-button');
            blockButtons.forEach(button => {
                button.addEventListener('click', function () {
                    currentItem = this.querySelector('img').src; // Get the image source from clicked block
                    currentEmoji = ''; // Clear emoji selection
                    currentColor = ''; // Clear color selection
                    deleteButton.style.color = '#e74c3c'; // Ensure delete mode is turned off
                    deleteMode = false; // Turn off delete mode when a block is selected
                });
            });

            const emojiButtons = document.querySelectorAll('.emoji-button');
            emojiButtons.forEach(button => {
                button.addEventListener('click', function () {
                    currentEmoji = this.dataset.emoji; // Get the emoji from clicked button
                    currentItem = ''; // Clear block selection
                    currentColor = ''; // Clear color selection
                    deleteButton.style.color = '#e74c3c'; // Ensure delete mode is turned off
                    deleteMode = false; // Turn off delete mode when an emoji is selected
                });
            });

            // Add Emoji functionality
            const addEmojiButton = document.getElementById('addEmojiButton');
            addEmojiButton.addEventListener('click', function () {
                const emojiCode = document.getElementById('emojiInput').value.trim();
                if (emojiCode) {
                    const emojiButton = document.createElement('div');
                    emojiButton.className = 'emoji-button';
                    emojiButton.dataset.emoji = emojiCode; // Store emoji in dataset
                    emojiButton.textContent = emojiCode; // Set emoji text
                    emojiButton.style.fontSize = '20px'; // Set emoji size
                    
                    // Adding click event to the new emoji button
                    emojiButton.addEventListener('click', function () {
                        currentEmoji = this.dataset.emoji; // Get the emoji from clicked button
                        currentItem = ''; // Clear block selection
                        currentColor = ''; // Clear color selection
                        deleteButton.style.color = '#e74c3c'; // Ensure delete mode is turned off
                        deleteMode = false; // Turn off delete mode when an emoji is selected
                    });

                    // Append the new emoji button to the emoji list
                    document.getElementById('emojiList').appendChild(emojiButton);
                    document.getElementById('emojiInput').value = ''; // Clear input field
                } else {
                    alert('Please enter an emoji.');
                }
            });

            // Color block addition
            const addColorButton = document.getElementById('addColorButton');
            addColorButton.addEventListener('click', function () {
                const colorCode = document.getElementById('colorInput').value.trim();
                const isValidHex = /^#[0-9A-F]{6}$/i.test(colorCode); // Regex to validate hex color

                if (isValidHex) {
                    // Create a new block using a div element with hex background color
                    const colorBlock = document.createElement('div');
                    colorBlock.style.width = '20px'; // Block width
                    colorBlock.style.height = '20px'; // Block height
                    colorBlock.style.backgroundColor = colorCode; // Set hex color
                    colorBlock.className = 'block-button'; // Optional: give it some similar styling

                    // Adding click event to place the color block
                    colorBlock.addEventListener('click', function () {
                        currentItem = ''; // Clear image selection
                        currentEmoji = ''; // Clear emoji selection
                        currentColor = colorCode; // Use color code for placement
                        deleteButton.style.color = '#e74c3c'; // Ensure delete mode is turned off
                        deleteMode = false; // Turn off delete mode
                    });

                    // Append the block to the toolbox
                    document.getElementById('blockImageList').appendChild(colorBlock);
                    customColorBlocks.push(colorCode); // Save the color block
                    localStorage.setItem(localStorageKey, JSON.stringify(customColorBlocks)); // Update local storage
                } else {
                    alert('Invalid hex code. Please use format: #FFFFFF');
                }
            });

            // Save the current state of the map to local storage
            function saveMap() {
                const mapData = Array.from(grid.children).map((cell) => ({
                    filled: cell.dataset.filled === 'true',
                    emoji: cell.dataset.emoji || null,
                    blockImage: cell.querySelector('img') ? cell.querySelector('img').src : null, // Capture block image
                    colorBlock: cell.dataset.colorBlock || null, // Capture color if exists
                    coin: cell.dataset.coin || null // Capture coin information
                }));

                localStorage.setItem('mapData', JSON.stringify(mapData));
            }

            // Load the previous map state from local storage
            function loadMap() {
                const savedMapData = localStorage.getItem('mapData');
                if (savedMapData) {
                    const mapData = JSON.parse(savedMapData);
                    // Clear the grid before loading the new map
                    Array.from(grid.children).forEach(cell => {
                        cell.innerHTML = ''; // Clear all cells
                        delete cell.dataset.filled; // Clear filled status
                        delete cell.dataset.emoji; // Clear emoji from dataset
                        delete cell.dataset.colorBlock; // Clear color block dataset
                        delete cell.dataset.coin; // Clear coin dataset
                    });

                    // Populate grid with the uploaded data
                    mapData.forEach((cellData, index) => {
                        const cell = grid.children[index];
                        if (cellData.filled) {
                            cell.dataset.filled = 'true';
                            if (cellData.emoji) {
                                const emojiElement = document.createElement('div');
                                emojiElement.textContent = cellData.emoji; // Set emoji text
                                emojiElement.style.fontSize = '20px'; // Set emoji size
                                cell.appendChild(emojiElement); // Append emoji to cell
                                cell.dataset.emoji = cellData.emoji; // Store the emoji in the dataset
                            } else if (cellData.blockImage) {
                                const blockElement = document.createElement('img'); // Create an img for the block
                                blockElement.src = cellData.blockImage; // Set the block image source
                                blockElement.style.width = '20px'; // Set block size
                                blockElement.style.height = '20px'; // Set block size
                                cell.appendChild(blockElement); // Append the block image
                            } else if (cellData.colorBlock) {
                                const colorBlockElement = document.createElement('div'); // Create a div for the color block
                                colorBlockElement.style.backgroundColor = cellData.colorBlock; // Set the background color
                                colorBlockElement.className = 'color-block'; // Add class for styling
                                colorBlockElement.style.width = '20px'; // Block width
                                colorBlockElement.style.height = '20px'; // Block height
                                cell.appendChild(colorBlockElement); // Append the color block
                            }
                        }
                        // Load coins if they exist
                        if (cellData.coin) {
                            cell.innerHTML = '<span class="coin">üí∞</span>'; // Append the coin UI
                            cell.dataset.filled = true; // Mark as filled
                            cell.dataset.coin = 'true'; // Store coin dataset
                        }
                    });

                    // After uploading the map, check the player's position
                    checkPlayerPosition();
                }
                // Load custom color blocks into the toolbox
                customColorBlocks.forEach(color => {
                    const colorBlock = document.createElement('div');
                    colorBlock.style.width = '20px'; // Block width
                    colorBlock.style.height = '20px'; // Block height
                    colorBlock.style.backgroundColor = color; // Set hex color
                    colorBlock.className = 'block-button'; // Optional: give it some similar styling
                    // Adding click event to support block placing
                    colorBlock.addEventListener('click', function () {
                        currentItem = ''; // Clear image selection
                        currentEmoji = ''; // Clear emoji selection
                        currentColor = color; // Use color code for placement
                        deleteButton.style.color = '#e74c3c'; // Ensure delete mode is turned off
                        deleteMode = false; // Turn off delete mode
                    });
                    document.getElementById('blockImageList').appendChild(colorBlock);
                });
            }

            // Check and adjust player position if they are inside a block
            function checkPlayerPosition() {
                const playerCell = grid.children[position.y * 40 + position.x];
                if (playerCell.dataset.filled) {
                    // Find the first empty cell to relocate the player
                    for (let i = 0; i < grid.children.length; i++) {
                        if (!grid.children[i].dataset.filled) {
                            position.x = i % 40; // Calculate new x position
                            position.y = Math.floor(i / 40); // Calculate new y position
                            movePlayer(position); // Move player to this empty position
                            break; // Exit loop after finding the first empty cell
                        }
                    }
                }
            }

            // Save the map to a JSON file
            document.getElementById('saveMapButton').addEventListener('click', function () {
                const mapData = localStorage.getItem('mapData');
                if (mapData) {
                    const blob = new Blob([mapData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'map.json'; // File name for download
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('No map data available to save.');
                }
            });

            // Upload map functionality
            document.getElementById('uploadMapButton').addEventListener('click', function () {
                document.getElementById('uploadMapInput').click(); // Trigger file input
            });

            // Load a map from a JSON file
            document.getElementById('uploadMapInput').addEventListener('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const uploadedData = JSON.parse(e.target.result);
                        
                        // Clear the current map
                        Array.from(grid.children).forEach(cell => {
                            cell.innerHTML = '';
                            delete cell.dataset.filled; // Clear dataset
                            delete cell.dataset.emoji; // Clear emoji from dataset
                            delete cell.dataset.colorBlock; // Clear color block dataset
                            delete cell.dataset.coin; // Clear coin dataset
                        });

                        // Populate grid with the uploaded data
                        uploadedData.forEach((cellData, index) => {
                            const cell = grid.children[index];
                            if (cellData.filled) {
                                cell.dataset.filled = 'true';
                                if (cellData.emoji) {
                                    const emojiElement = document.createElement('div');
                                    emojiElement.textContent = cellData.emoji; // Set emoji text
                                    emojiElement.style.fontSize = '20px'; // Set emoji size
                                    cell.appendChild(emojiElement); // Append emoji
                                    cell.dataset.emoji = cellData.emoji; // Store emoji in dataset
                                } else if (cellData.blockImage) {
                                    const blockElement = document.createElement('img'); // Create an img for the block
                                    blockElement.src = cellData.blockImage; // Set the block image source
                                    blockElement.style.width = '20px'; // Set block size
                                    blockElement.style.height = '20px'; // Set block size
                                    cell.appendChild(blockElement); // Append the block image
                                } else if (cellData.colorBlock) {
                                    const colorBlockElement = document.createElement('div'); // Create a div for the color block
                                    colorBlockElement.style.backgroundColor = cellData.colorBlock; // Set the background color
                                    colorBlockElement.className = 'color-block'; // Add class for styling
                                    colorBlockElement.style.width = '20px'; // Block width
                                    colorBlockElement.style.height = '20px'; // Block height
                                    cell.appendChild(colorBlockElement); // Append the color block
                                }
                            }
                            // Load coins if they exist
                            if (cellData.coin) {
                                cell.innerHTML = '<span class="coin">üí∞</span>'; // Append the coin UI
                                cell.dataset.filled = true; // Mark as filled
                                cell.dataset.coin = 'true'; // Store coin dataset
                            }
                        });

                        updateDisplay(); // Update the display after loading the new map
                        // Reload portals from local storage to ensure they work post-upload
                        portals = JSON.parse(localStorage.getItem('portals')) || [];
                        saveMap(); // Save to local storage for safety
                        // Check and adjust player position if necessary
                        checkPlayerPosition();
                    };
                    reader.readAsText(file);
                }
            });

            // Save player position to localStorage
            function savePlayerPosition() {
                localStorage.setItem('playerPosition', JSON.stringify(position));
            }

            // Start the coin timer when the game starts
            startCoinTimer();
        }
    </script>
</body>
</html>
     
