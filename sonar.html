<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonar Map Game with Coins and Sound Effects</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
            box-sizing: border-box;
        }

        .grid-container {
            position: relative;
            overflow: hidden;
            width: 800px;
            height: 800px;
            border: 2px solid #fff;
            margin-right: 10px;
            border-radius: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(40, 20px);
            grid-auto-rows: 20px;
            position: absolute;
            top: 0;
            left: 0;
            transition: transform 0.2s;
        }

        .grid div {
            position: relative;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #2980b9;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .grid div:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .player {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(46, 204, 113, 0.8);
            border-radius: 50%;
            transition: transform 0.2s;
            z-index: 1;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 220px;
        }

        #coordinates,
        #timer,
        #coins,
        #coinTimer {
            margin-top: 5px;
            font-size: 18px;
            text-align: center;
        }

        #resetButton {
            padding: 8px;
            background-color: #e74c3c;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 16px;
        }

        #resetButton:hover {
            background-color: #c0392b;
        }

        .tool-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .tool-box h2 {
            margin: 0 0 5px 0;
            font-size: 18px;
            text-decoration: underline;
        }

        .emoji-list,
        .color-palette {
            display: flex;
            justify-content: center;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .emoji-button,
        .color-swatch {
            cursor: pointer;
            padding: 5px;
            border: none;
            border-radius: 5px;
            margin: 2px;
            font-size: 18px;
            display: inline-block;
            transition: transform 0.2s;
        }

        .emoji-button:hover {
            transform: scale(1.1);
        }

        .color-swatch {
            width: 25px;
            height: 25px;
            border: 1px solid #fff;
        }

        .delete-button {
            cursor: pointer;
            color: #e74c3c;
            margin-top: 5px;
            font-size: 28px;
        }

        .chat-container {
            position: absolute;
            width: 200px;
            bottom: 90px; /* Position it above the player */
            left: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 5px;
            z-index: 2;
        }

        .chat-log {
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 14px;
            color: black;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 5px;
        }

        .message {
            margin: 5px 0;
        }

        input {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            color: black;
            outline: none;
            margin-bottom: 5px;
            font-size: 14px;
        }

        #addEmojiButton,
        #addColorButton {
            margin-top: 5px;
            padding: 5px;
            background-color: #2980b9;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
        }

        #addEmojiButton:hover,
        #addColorButton:hover {
            background-color: #1a5276;
        }

        .coin {
            font-size: 20px;
            color: gold;
            position: relative;
            z-index: 0;
        }

        .uploaded-image {
            width: 20px;
            height: 20px;
        }

        .large-emoji {
            width: 30px;
            height: 30px;
        }
    </style>
</head>

<body>
    <div class="grid-container">
        <div class="grid" id="grid"></div>
        <div class="player" id="player"></div>
    </div>

    <div class="sidebar">
        <div id="coordinates">Coordinates: (20, 20)</div>
        <div id="timer">Time: 0s</div>
        <div id="coins">Coins: 0</div>
        <div id="coinTimer">Next Coin in: 60s</div>
        <div class="tool-box">
            <h2>Tools</h2>
            <div class="emoji-list" id="emojiList"></div>

            <input type="text" id="customEmojiInput" placeholder="Add a custom emoji" />
            <button id="addEmojiButton">Add Emoji</button>

            <div class="color-palette" id="colorPalette">
                <!-- Common Colors Added Here -->
                <div class="color-swatch" data-color="#FF0000" style="background-color: #FF0000;"></div>
                <div class="color-swatch" data-color="#00FF00" style="background-color: #00FF00;"></div>
                <div class="color-swatch" data-color="#0000FF" style="background-color: #0000FF;"></div>
                <div class="color-swatch" data-color="#FFFF00" style="background-color: #FFFF00;"></div>
                <div class="color-swatch" data-color="#FF00FF" style="background-color: #FF00FF;"></div>
                <div class="color-swatch" data-color="#00FFFF" style="background-color: #00FFFF;"></div>
                <div class="color-swatch" data-color="#FFFFFF" style="background-color: #FFFFFF;"></div>
                <div class="color-swatch" data-color="#000000" style="background-color: #000000;"></div>
                <div class="color-swatch" data-color="#A52A2A" style="background-color: #A52A2A;"></div>
                <div class="color-swatch" data-color="#FFA500" style="background-color: #FFA500;"></div>
            </div>

            <input type="text" id="colorInput" placeholder="Enter hex code (e.g. #ABCDEF)" />
            <button id="addColorButton">Add Color</button>

            <div class="delete-button" id="deleteButton">‚ùå</div>
            <button id="toggleSizeButton">Toggle Emoji Size</button>
        </div>

        <div class="chat-container">
            <div class="chat-log" id="chatLog"></div>
            <input type="text" id="chatInput" placeholder="Type a message..." />
            <input type="file" id="imageUpload" style="display: none;" />
        </div>

        <button id="resetButton">Reset Map</button>
    </div>

    <audio id="placeSound" src="place-sound.mp3" preload="auto"></audio>
    <audio id="coinCollectSound" src="coin-collect-sound.mp3" preload="auto"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); // Initialize socket connection
        const player = document.getElementById('player');
        const grid = document.getElementById('grid');
        const chatLog = document.getElementById('chatLog');
        const input = document.getElementById('chatInput');
        const coordinatesDisplay = document.getElementById('coordinates');
        const timerDisplay = document.getElementById('timer');
        const resetButton = document.getElementById('resetButton');
        const emojiList = document.getElementById('emojiList');
        const customEmojiInput = document.getElementById('customEmojiInput');
        const addEmojiButton = document.getElementById('addEmojiButton');
        const colorSwatches = document.querySelectorAll('.color-swatch');
        const deleteButton = document.getElementById('deleteButton');
        const coinsDisplay = document.getElementById('coins');
        const coinTimerDisplay = document.getElementById('coinTimer');
        const imageUpload = document.getElementById('imageUpload');
        const toggleSizeButton = document.getElementById('toggleSizeButton');
        const colorInput = document.getElementById('colorInput');
        const addColorButton = document.getElementById('addColorButton');
        const colorPalette = document.getElementById('colorPalette');

        const placeSound = document.getElementById('placeSound');
        const coinCollectSound = document.getElementById('coinCollectSound');

        let position = { x: 20, y: 20 }; // Starting position
        let currentEmoji = 'üè†';
        let selectedColor = '#e74c3c';
        let time = 0;
        let timerInterval;
        let isDeleting = false;
        let coins = 0;
        let coinPosition = { x: -1, y: -1 };
        let coinCountdown = 60; // Countdown for next coin spawn
        let coinSpawned = false; // Track if a coin is currently on the map

        let emojiSizeLarge = false; // Toggle for emoji size
        const players = {}; // Object to hold all players

        // Preset emojis
        const presetEmojis = ['üè†', 'üå≤', 'üåä', 'üçé', 'üåû', 'üèñÔ∏è'];

        presetEmojis.forEach(addEmojiToList);

        // Create a larger grid (40x40)
        for (let i = 0; i < 1600; i++) {
            const cell = document.createElement('div');
            cell.addEventListener('click', function () {
                if (isDeleting) {
                    if (this.dataset.filled) {
                        this.innerHTML = '';
                        this.style.backgroundColor = 'transparent';
                        delete this.dataset.filled;
                        saveGridState();
                    }
                } else {
                    if (!this.dataset.filled) {
                        // Emit an event for placing an emoji
                        socket.emit('placeEmoji', {
                            emoji: currentEmoji,
                            color: selectedColor,
                            position: { x: position.x, y: position.y }
                        });
                        this.innerHTML = currentEmoji === 'color' ? '' : currentEmoji;
                        this.style.backgroundColor = currentEmoji === 'color' ? selectedColor : 'transparent';
                        this.dataset.filled = true;
                        saveGridState();
                        placeSound.play();  // Play sound when placing an emoji
                    }
                }
            });
            grid.appendChild(cell);
        }

        // Load saved grid from local storage
        loadGridState();

        // Listen for emoji placement from other players
        socket.on('placeEmoji', function (data) {
            const targetCell = grid.children[data.position.y * 40 + data.position.x];
            if (targetCell) {
                targetCell.innerHTML = data.emoji === 'color' ? '' : data.emoji;
                targetCell.style.backgroundColor = data.emoji === 'color' ? data.color : 'transparent';
                targetCell.dataset.filled = true;
            }
        });

        // Function to spawn coins at set intervals
        function startCoinTimer() {
            coinTimerDisplay.textContent = `Next Coin in: ${coinCountdown}s`;
            const coinTimerInterval = setInterval(() => {
                coinCountdown--;
                coinTimerDisplay.textContent = `Next Coin in: ${coinCountdown}s`;
                if (coinCountdown <= 0) {
                    spawnCoin();
                    coinCountdown = 60; // Reset countdown after coin spawn
                    clearInterval(coinTimerInterval); // Clear and restart the interval
                    startCoinTimer();
                }
            }, 1000);
        }

        function spawnCoin() {
            if (!coinSpawned) {
                let x = Math.floor(Math.random() * 40);
                let y = Math.floor(Math.random() * 40);
                const targetCell = grid.children[y * 40 + x];
                if (!targetCell.dataset.filled && targetCell.innerHTML === '') { // Ensure a coin spawns in an empty cell
                    targetCell.innerHTML = '<div class="coin">üí∞</div>';
                    coinPosition = { x, y };
                    coinSpawned = true; // Mark that a coin has been spawned
                    coinCountdown = 60; // Reset the countdown when a coin is spawned
                    coinTimerDisplay.textContent = `Next Coin in: ${coinCountdown}s`;
                }
            } else {
                // Coin already spawned, just reset the countdown
                coinCountdown = 60;
            }
        }

        // Check for coin collection
        function checkCoinCollection() {
            if (position.x === coinPosition.x && position.y === coinPosition.y) {
                coins++;
                coinsDisplay.textContent = `Coins: ${coins}`;
                coinCollectSound.play();  // Play the sound when collecting a coin
                const targetCell = grid.children[coinPosition.y * 40 + coinPosition.x];
                targetCell.innerHTML = ''; // Remove the coin from the grid
                coinSpawned = false; // Reset the coin spawn status
                spawnCoin(); // Spawn a new coin
                saveCoins();
            }
        }

        // Function to load emojis from local storage
        function loadEmojis() {
            const savedEmojis = JSON.parse(localStorage.getItem('emojis')) || [];
            savedEmojis.forEach(emoji => {
                addEmojiToList(emoji);
            });
        }

        // Function to add emoji button to the toolbox if it doesn't already exist
        function addEmojiToList(emoji) {
            const emojiButton = document.createElement('div');
            emojiButton.className = 'emoji-button';
            emojiButton.innerHTML = emoji; // Changed from textContent to innerHTML for images
            emojiButton.addEventListener('click', function () {
                currentEmoji = this.innerHTML; // Use innerHTML for images
                isDeleting = false;
            });
            emojiList.appendChild(emojiButton);
        }

        // Handle adding a custom emoji
        addEmojiButton.addEventListener('click', function () {
            const newEmoji = customEmojiInput.value.trim();
            if (newEmoji && !emojiList.innerHTML.includes(newEmoji)) {
                addEmojiToList(newEmoji);
                saveEmojis();
                customEmojiInput.value = ''; // Clear input field
            }
        });

        // Handle text input for chat
        input.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                const message = input.value.trim();
                if (message) {
                    const msgElement = document.createElement('div');
                    msgElement.className = 'message';
                    msgElement.textContent = `Player: ${message}`;
                    chatLog.appendChild(msgElement);
                    chatLog.scrollTop = chatLog.scrollHeight; // Scroll to the bottom of the chat log

                    // Emit chat message to the server
                    socket.emit('chatMessage', message);

                    input.value = ''; // Clear input field
                }
            }
        });

        // Listen for chat messages from other players
        socket.on('chatMessage', function (message) {
            const msgElement = document.createElement('div');
            msgElement.className = 'message';
            msgElement.textContent = `Player: ${message}`;
            chatLog.appendChild(msgElement);
            chatLog.scrollTop = chatLog.scrollHeight; // Scroll to the bottom of the chat log
        });

        // Move player with WASD keys and update grid based on player movement
        document.addEventListener('keydown', function (event) {
            let newPos = { ...position };

            if (event.key === 'w' && position.y > 0) newPos.y--;
            else if (event.key === 's' && position.y < 39) newPos.y++;
            else if (event.key === 'a' && position.x > 0) newPos.x--;
            else if (event.key === 'd' && position.x < 39) newPos.x++;

            // Check if the new position is valid
            const targetCell = grid.children[newPos.y * 40 + newPos.x];
            if (!targetCell.dataset.filled) {
                position = newPos;
                updatePlayerPosition();
                updateCoordinates();
                checkCoinCollection(); // Check for coin collection
                
                // Emit the player movement to the server
                socket.emit('playerMove', { id: socket.id, position });
            }
        });

        // Listen for player movements from other players
        socket.on('playerMove', function (data) {
            const playerDiv = document.getElementById(`player-${data.id}`);
            if (!playerDiv) {
                // Create a new player div if it doesn't exist
                const newPlayerDiv = document.createElement('div');
                newPlayerDiv.id = `player-${data.id}`;
                newPlayerDiv.className = 'player';
                grid.appendChild(newPlayerDiv);
            }
            // Update player position
            document.getElementById(`player-${data.id}`).style.transform = `translate(${data.position.x * 20}px, ${data.position.y * 20}px)`;
        });

        function updatePlayerPosition() {
            player.style.transform = `translate(${(position.x * 20)}px, ${(position.y * 20)}px)`;
            updateCoordinates();
        }

        function updateCoordinates() {
            coordinatesDisplay.textContent = `Coordinates: (${position.x}, ${position.y})`;
        }

        // Reset functionality
        resetButton.addEventListener('click', function () {
            Array.from(grid.children).forEach(cell => {
                cell.innerHTML = '';
                cell.style.backgroundColor = 'transparent';
                delete cell.dataset.filled; // Clear dataset for the reset
            });
            time = 0;
            timerDisplay.textContent = `Time: ${time}s`;
            position = { x: 20, y: 20 };
            updatePlayerPosition();

            // Ensure preset emojis are added back to the toolbox
            emojiList.innerHTML = ''; // Clear current emojis in the toolbox
            presetEmojis.forEach(addEmojiToList); // Re-add preset emojis
        });

        // Start the timer and coin spawning when the script runs
        startCoinTimer();
        updatePlayerPosition(); // Initialize player position
    </script>
</body>

</html>
